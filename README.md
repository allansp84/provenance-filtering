# Provenance Filtering

This software aims to find the most related images with respect to a
given query, in terms of possible ancestors (donors or contributors) and
descendants, in a potentially large pool of images. It was developed
using the Python 3.5 language and tested on Ubuntu 16.04 LTS.

## API Dependencies

The following python packages are required to run this software:
* Cython-0.24.1
* joblib-0.8.4
* numpy-1.11.1
* matplotlib-1.5.1
* pbr-1.3.0
* Pillow-3.3.0
* pyparsing-2.1.10
* scikit-image-0.12.3
* scikit-learn-0.17.1
* scipy-0.18.0
* memory-profiler-0.41
* psutil-4.3.0
* Bottleneck-1.1.0
* h5py-2.7.0
* flann-1.9.1
* opencv-3.2.0 + opencv_contrib-3.2.0
* boost-1.62.0

### Related Projects

Besides those dependencies, this software is related to two other projects:
*   [Space-Filling Curves](https://gitlab.mediforprogram.com/ndpurdue/space-filling-curves)
*   [context-mask-generator](https://gitlab.mediforprogram.com/ndpurdue/context-mask-generator)

Note:
1. The Space-Filling Curves package provides a wrapper for Python-3.5 language,
which can be installed by using the
script provided in [02_install_provenance_filtering.sh](https://gitlab.mediforprogram.com/ndpurdue/provenance-filtering/blob/master/scripts/02_install_provenance_filtering.sh).
2. The contextual masks generated by [context-mask-generator](https://gitlab.mediforprogram.com/ndpurdue/context-mask-generator)
are used as input in our software during the second tier/stage of search.
Please, access the scripts [09_applying_context_masks_for_2nd_tier_of_search.sh](https://gitlab.mediforprogram.com/ndpurdue/provenance-filtering/blob/master/scripts/09_applying_context_masks_for_2nd_tier_of_search.sh)
and [example_7_NDPURDUE_NC17_NC17Eval_ProvenanceFiltering_ImgOnly_c-contrast4_1.sh](https://gitlab.mediforprogram.com/ndpurdue/provenance-filtering/blob/master/scripts/example_7_NDPURDUE_NC17_NC17Eval_ProvenanceFiltering_ImgOnly_c-contrast4_1.sh)
to see how to use these contextual masks in our software.

## How to install this software?
We provide two scripts to install this software on your system:
* [01_install_dependences.sh](https://gitlab.mediforprogram.com/ndpurdue/provenance-filtering/blob/master/scripts/01_install_dependences.sh)
* [02_install_provenance_filtering.sh](https://gitlab.mediforprogram.com/ndpurdue/provenance-filtering/blob/master/scripts/02_install_provenance_filtering.sh)

The first script will install the opencv-3.2.0, boost-1.62.0 and flann-1.9.1 packages in a
virtual environment named as *prov-filt-env*. The second script will install the
[Space-Filling Curves](https://gitlab.mediforprogram.com/ndpurdue/space-filling-curves) package
and this software in your system. Please, execute the follows commands
to install this software and its dependencies.

     $ git clone git@gitlab.mediforprogram.com:ndpurdue/provenance-filtering.git
     $ cd provenance-filtering
     $ scripts/01_install_dependences.sh
     $ scripts/02_install_provenance_filtering.sh
     $ workon prov-filt-env
     (prov-filt-env) $ filtering.py                                              # -- execute this command to see if the provenance-filtering package is working properly

Note:
1. Please, activate this virtual environment whatever you want to use this software.
2. The Space-Filling Curves package is referenced in your system as *libsfc==0.1*.

## Usage

After installing our software, we can use it via command line interface (CLI).
To see how to use this software, execute the following command in any
directory, since it will be already installed in your system:

     (prov-filt-env) $ filtering.py --help

Parameters:
* --dataset_path: Path to the directory that contains the gallery set and probe set.
* --output_path: Path where the results will be saved.
* --probe_index: Path to the csv file that contains the list of images in the probe set.
* --gallery_index: Path to the csv file that contains the list of images in the gallery set.
* --path_to_masks: Path to the directory that contains the contextual masks generated by the [context-mask-generator](https://gitlab.mediforprogram.com/ndpurdue/context-mask-generator)
project.

## Examples
1. Extract the SURF key-points and SURF descriptors (2000 feature vectors per image) from all images in the probe and gallery set:
>
>     (prov-filt-env) $ filtering.py --dataset_path datasets/evaluation/NC2017_Eval_Ver1_Provenance \
>                                    --probe_index datasets/evaluation/NC2017_Eval_Ver1_Provenance/indexes/NC2017_Eval-provenancefiltering-index.csv \
>                                    --gallery_index datasets/evaluation/NC2017_Eval_Ver1_Provenance/indexes/NC2017_Eval-provenancefiltering-world.csv \
>                                    --output_path shared_output --n_jobs 4 \
>                                    --detector_kpm SURF --descriptor_kpm SURF --limit_kpm 2000 \
>                                    --feature_extraction

2. Index a set of images to perform an approximate nearest neighbors search using KD-Forest with two trees
>
>     (prov-filt-env) $ filtering.py --dataset_path datasets/evaluation/NC2017_Eval_Ver1_Provenance \
>                                    --gallery_index datasets/evaluation/NC2017_Eval_Ver1_Provenance/indexes/NC2017_Eval-provenancefiltering-world.csv \
>                                    --output_path shared_output --n_jobs 4 \
>                                    --detector_kpm SURF --descriptor_kpm SURF --limit_kpm 1000 \
>                                    --index_type_kpm KDFOREST --n_kdtree_kpm 2 \
>                                    --create_index

